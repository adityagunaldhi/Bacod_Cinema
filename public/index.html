<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOBA Cinema</title>
  <link rel="icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTMdOPkIQZ0rrJYOExiYqfN68ErDUSrCnPStw&s" type="image/x-icon">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <!-- Header -->
  <header class="bg text-white py-3">
    <div class="container text-center">
      <h1>BOBA Cinema</h1>
      <p>Tempat terbaik untuk menonton film favorit Anda</p>
    </div>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item active">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="approval.html" id="approval-link">Approval</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Transaction</a>
          </li>
        </ul>
        
      </div>
      <button type="button" class="btn btn-primary m-3" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
    </nav>
  </header>

  <!-- Hero Section -->
  <section class="hero-section">
    <h2>Welcome to BOBA Cinema</h2>
    <p>Discover the latest movies and book your tickets now!</p>
  </section>

  <!-- Movies Section -->
  <section class="container my-5">
    <h2 class="text-center mb-4">Now Showing</h2>
    <div id="showtimes-list" class="row"></div>
  </section>

  <!-- Modal Login -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Login</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="loginForm">
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" required>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" required>
          </div>
          <button type="submit" class="btn btn-primary">Login</button>
        </form>
        <p>Don't have an account? <a href="#" id="showRegisterForm">Sign up here</a></p>
      </div>
    </div>
  </div>
</div>

<!-- Modal Register -->
<div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="registerModalLabel">Register</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="registerForm">
          <div class="mb-3">
            <label for="newUsername" class="form-label">Username</label>
            <input type="text" class="form-control" id="newUsername" required>
          </div>
          <div class="mb-3">
            <label for="newPassword" class="form-label">Password</label>
            <input type="password" class="form-control" id="newPassword" required>
          </div>
          <div class="mb-3">
            <label for="newEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="newEmail" required>
          </div>
          <div class="mb-3">
            <label for="newPhone" class="form-label">Phone Number</label>
            <input type="text" class="form-control" id="newPhone" required>
          </div>
            <label for="newRole" class="form-role">Role</label>
            <input type="text" class="form-control" id="newRole" value="customer" readonly>
          </div>
          <button type="submit" class="btn btn-primary">Register</button>
        </form>
        <p>Already have an account? <a href="#" id="showLoginForm">Login here</a></p>
      </div>
    </div>
  </div>
</div>


  <!-- Modal Booking -->
  <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bookingModalLabel">Booking Showtime</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="bookingForm">
            <div class="mb-3">
              <label for="seats" class="form-label">Select Seats</label>
              <input type="text" class="form-control" id="seats" placeholder="Enter seat numbers (e.g. A1, A2)" required>
            </div>
            <div class="mb-3">
              <label for="paymentMethod" class="form-label">Payment Method</label>
              <select class="form-select" id="paymentMethod" required>
                <option value="credit_card">Credit Card</option>
                <option value="paypal">PayPal</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Book Now</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg text-white text-center py-3">
    <p>&copy; 2025 BOBA Cinema. All Rights Reserved.</p>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

  <!-- Script untuk handle form login dan booking -->
  <script>

        const registerForm = document.getElementById('registerForm');

        registerForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const username = document.getElementById('newUsername').value;
          const password = document.getElementById('newPassword').value;
          const email = document.getElementById('newEmail').value;
          const phone_number = document.getElementById('newPhone').value;
          const role = document.getElementById('newRole').value;

          try {
            const response = await fetch('http://localhost:5000/api/auth/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password, email, phone_number, role })
            });

            const data = await response.json();

            if (response.ok) {
              alert('Registration successful!');
              const modal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
              modal.hide();
            } else {
              alert(data.message || 'Registration failed. Please try again.');
            }
          } catch (error) {
            console.error('Error registering user:', error);
            alert('An error occurred. Please try again later.');
          }
        });


        const loginForm = document.getElementById('loginForm');
        const bookingForm = document.getElementById('bookingForm');
    
        //const token = localStorage.getItem('authToken');
        //if (token) {
          //loadShowtimes();
        //} else {
          //alert("Please log in to view the movies.");
        //}
    
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
        
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
        
          try {
            const response = await fetch('http://localhost:5000/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password })
            });
        
            const data = await response.json();
        
            if (response.ok) {
              alert('Login successful!');
              localStorage.setItem('authToken', data.token);
              const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
              modal.hide();
              loadShowtimes();
            } else {
              alert(data.message || 'Login failed. Please try again.');
            }
          } catch (error) {
            console.error('Error logging in:', error);
            alert('An error occurred. Please try again later.');
          }
        });


  document.getElementById('showLoginForm').addEventListener('click', (e) => {
  e.preventDefault();
  
  // Tutuplah modal register terlebih dahulu
  const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
  registerModal.hide();
  
  // Buka modal login
  const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
  loginModal.show();
  });

  document.getElementById('showRegisterForm').addEventListener('click', (e) => {
  e.preventDefault();
  
  // Tutuplah modal login terlebih dahulu
  const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
  loginModal.hide();
  
  // Buka modal register
  const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
  registerModal.show();
  });



    async function loadShowtimes() {
      try {
        const response = await fetch('http://localhost:5000/api/showtimes');
        const data = await response.json();

        if (data.showtimes && Array.isArray(data.showtimes)) {
          const showtimesList = document.getElementById("showtimes-list");
          showtimesList.innerHTML = "";

          const showtimeCards = data.showtimes.map(showtime => {
            return `
              <div class="col-md-4 mb-4">
                <div class="card">
                  <img src="${showtime.poster_image}" class="card-img-top" alt="${showtime.movie_title}">
                  <div class="card-body text-center">
                    <h5 class="card-title">${showtime.movie_title}</h5>
                    <p class="card-text">Start: ${new Date(showtime.start_time).toLocaleString()}</p>
                    <p class="card-text">End: ${new Date(showtime.end_time).toLocaleString()}</p>
                    <p class="card-text">Price: Rp.${showtime.price}</p>
                    <button type="button" class="btn btn-primary" onclick="window.location.href='showtime.html?showtime_id=${showtime.showtime_id}'">Preview</button>
                  </div>
                </div>
              </div>
            `;
          });

          showtimesList.innerHTML = showtimeCards.join('');
        } else {
          console.error("Invalid data format:", data);
          alert("Error: Invalid data format received from the server.");
        }
      } catch (error) {
        console.error("Error loading showtimes:", error);
        alert("Failed to load showtimes. Please try again later.");
      };
    };

    window.onload = loadShowtimes;

    function openBookingModal(showtime_id, movie_title, price) {
      if (!localStorage.getItem('authToken')) {
        alert("Please log in to make a booking.");
        return;
      }

      const modalTitle = document.getElementById('bookingModalLabel');
      modalTitle.textContent = `Booking for ${movie_title}`;
      document.getElementById('seats').value = '';
      document.getElementById('paymentMethod').value = 'credit_card';

      bookingForm.dataset.showtimeId = showtime_id;
      bookingForm.dataset.price = price;

      const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
      modal.show();
    }

    bookingForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const seats = document.getElementById('seats').value.split(',').map(seat => seat.trim());
      const paymentMethod = document.getElementById('paymentMethod').value;
      const showtimeId = bookingForm.dataset.showtimeId;
      const price = bookingForm.dataset.price;

      try {
        const response = await fetch('http://localhost:5000/api/bookings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify({ showtimeId, seats, price, paymentMethod })
        });

        const data = await response.json();

        if (response.ok) {
          alert('Booking successful!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
          modal.hide();
        } else {
          alert(data.message || 'Booking failed. Please try again.');
        }
      } catch (error) {
        console.error('Error booking showtime:', error);
        alert('An error occurred. Please try again later.');
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
    const approvalLink = document.getElementById('approval-link');

    // Ambil token dari localStorage
    const token = localStorage.getItem('authToken');

    if (token) {
        try {
            // Decode token untuk mendapatkan payload
            const payload = JSON.parse(atob(token.split('.')[1])); // Hanya berlaku untuk JWT

            // Periksa apakah pengguna adalah admin
            if (payload.role !== 'admin') {
                console.warn('Access denied: User is not an admin');
                approvalLink.style.display = 'none'; // Sembunyikan link
            }
        } catch (error) {
            console.error('Invalid token format:', error);
            approvalLink.style.display = 'none'; // Sembunyikan link jika token tidak valid
        }
    } else {
        console.warn('No token found: User not logged in');
        approvalLink.style.display = 'none'; // Sembunyikan link jika tidak ada token
    }
});

  </script>
</body>
</html>
